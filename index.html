<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²©å›½å¸‚ã®å¤©æ°—äºˆå ± (48æ™‚é–“)</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0077b6;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333333;
            --accent-rain: #023e8a;
            --accent-sun: #ffb703;
            --accent-cloud: #6c757d;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .forecast-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 160px;
        }

        .forecast-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.1);
        }

        .time {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            display: block;
        }

        .weather-icon {
            font-size: 2rem;
            margin: 10px 0;
        }

        .temp {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .rain-prob {
            font-size: 0.85rem;
            color: #555;
            margin-top: 5px;
            background: #eef2f6;
            border-radius: 10px;
            padding: 2px 8px;
            display: inline-block;
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        /* å¤©æ°—ã«å¿œã˜ãŸç°¡å˜ãªè‰²åˆ†ã‘ï¼ˆJSã§ã‚¯ãƒ©ã‚¹ä»˜ä¸æ™‚ï¼‰ */
        .weather-sunny .weather-icon { color: var(--accent-sun); }
        .weather-cloudy .weather-icon { color: var(--accent-cloud); }
        .weather-rainy .weather-icon { color: var(--accent-rain); }
    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>å²©å›½å¸‚ã®å¤©æ°—äºˆå ±</h1>
            <p class="subtitle">ä»Šå¾Œ48æ™‚é–“ã®äºˆå ± (Powered by Open-Meteo)</p>
            <div id="current-time" class="timestamp"></div>
        </header>
        
        <main id="forecast-container" class="forecast-grid">
            <!-- JavaScriptã§ã“ã“ã«äºˆå ±ã‚«ãƒ¼ãƒ‰ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </main>
    </div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«è¡¨ç¤º
        window.onerror = function(message, source, lineno, colno, error) {
            const container = document.getElementById('forecast-container');
            if (container) {
                container.innerHTML = `
                    <div class="loading" style="color: #d32f2f; text-align: left; background: #ffebee; padding: 20px; border-radius: 8px;">
                        <strong>äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</strong><br>
                        ${message}<br>
                        <small>File: ${source}, Line: ${lineno}</small>
                    </div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const LAT = 34.16;
            const LON = 132.22;
            
            // API URL (timezone=Asia/Tokyoã‚’æŒ‡å®š)
            const apiURL = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia%2FTokyo`;

            const container = document.getElementById('forecast-container');
            const timeDisplay = document.getElementById('current-time');

            // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
            const now = new Date();
            if (timeDisplay) {
                timeDisplay.textContent = `å–å¾—æ—¥æ™‚: ${now.toLocaleString('ja-JP')}`;
            }

            console.log("Fetching data from:", apiURL);

            fetch(apiURL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    renderForecast(data);
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    if (container) {
                        container.innerHTML = `
                            <div class="loading" style="color: #d32f2f;">
                                ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
                                ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
                                <small>${error.message}</small>
                            </div>`;
                    }
                });

            function renderForecast(data) {
                if (!container) return;
                container.innerHTML = ''; // Loadingè¡¨ç¤ºã‚¯ãƒªã‚¢

                const hourly = data.hourly;
                if (!hourly) {
                    throw new Error("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™ (hourly data missing)");
                }

                // ç¾åœ¨æ™‚åˆ» (JST) ã®æ–‡å­—åˆ— "YYYY-MM-DDTHH:mm" ã‚’ä½œæˆã—ã¦æ¯”è¼ƒ
                // APIã®timeã¯ "2023-12-14T12:00" ã®ã‚ˆã†ãªãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“(JST)æ–‡å­—åˆ—
                const nowJST = new Date(Date.now() + 9 * 60 * 60 * 1000); // UTCæ™‚é–“ã«9æ™‚é–“è¶³ã™
                const currentIsoJST = nowJST.toISOString().slice(0, 16);  // "YYYY-MM-DDTHH:mm"

                // ç¾åœ¨æ™‚åˆ»ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã™
                let startIndex = hourly.time.findIndex(t => t >= currentIsoJST);
                
                // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼ˆAPIãƒ‡ãƒ¼ã‚¿ãŒå¤ã„ã€ã¾ãŸã¯æ—¥ä»˜è·¨ãã®ä¸æ•´åˆï¼‰ã¯0ã‹ã‚‰
                if (startIndex === -1) startIndex = 0;

                // 48æ™‚é–“åˆ†ã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹é™ã‚Šè¡¨ç¤º
                const count = 48;
                const endIndex = Math.min(startIndex + count, hourly.time.length);

                // ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ«ãƒ¼ãƒ—
                for (let i = startIndex; i < endIndex; i++) {
                    const timeStr = hourly.time[i];
                    const temp = hourly.temperature_2m[i];
                    const rainProb = hourly.precipitation_probability[i];
                    const code = hourly.weathercode[i];

                    // æ—¥ä»˜è¡¨ç¤ºç”¨ã®å‡¦ç†
                    const dateObj = new Date(timeStr);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const hour = dateObj.getHours();

                    const weatherInfo = getWeatherInfo(code);

                    const card = document.createElement('div');
                    card.className = `forecast-card weather-${weatherInfo.classType}`;
                    
                    // æ™‚é–“ã®è¡¨ç¤º (0æ™‚ã®å ´åˆã¯æ—¥ä»˜ã‚‚å…¥ã‚Œã‚‹)
                    let timeLabel = `${hour}:00`;
                    if (hour === 0 || i === startIndex) {
                        timeLabel = `<span style="font-size:0.8em">${month}/${day}</span> ${hour}:00`;
                    }

                    card.innerHTML = `
                        <span class="time">${timeLabel}</span>
                        <div class="weather-icon" title="${weatherInfo.text}">${weatherInfo.icon}</div>
                        <div class="temp">${temp}â„ƒ</div>
                        <div class="rain-prob">â˜” ${rainProb === null ? 0 : rainProb}%</div>
                    `;
                    
                    container.appendChild(card);
                }
            }

            function getWeatherInfo(code) {
                if (code === 0) return { text: 'å¿«æ™´', icon: 'â˜€', classType: 'sunny' };
                if (code === 1 || code === 2 || code === 3) return { text: 'æ™´ã‚Œ/æ›‡ã‚Š', icon: 'â›…', classType: 'cloudy' };
                if (code === 45 || code === 48) return { text: 'éœ§', icon: 'ğŸŒ«', classType: 'cloudy' };
                if (code >= 51 && code <= 55) return { text: 'éœ§é›¨', icon: 'ğŸŒ¦', classType: 'rainy' };
                if (code >= 61 && code <= 65) return { text: 'é›¨', icon: 'â˜”', classType: 'rainy' };
                if (code >= 66 && code <= 67) return { text: 'æ°·é›¨', icon: 'ğŸŒ¨', classType: 'rainy' };
                if (code >= 71 && code <= 77) return { text: 'é›ª', icon: 'â›„', classType: 'cloudy' };
                if (code >= 80 && code <= 82) return { text: 'ã«ã‚ã‹é›¨', icon: 'â˜‚', classType: 'rainy' };
                if (code >= 85 && code <= 86) return { text: 'é›ª', icon: 'â˜ƒ', classType: 'cloudy' };
                if (code >= 95) return { text: 'é›·é›¨', icon: 'âš¡', classType: 'rainy' };
                return { text: 'ä¸æ˜', icon: 'â“', classType: 'cloudy' };
            }
        });
    </script>
</body>
</html>