<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²©å›½å¸‚ å¤©æ°—äºˆå ±ã‚°ãƒ©ãƒ• (24æ™‚é–“)</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0077b6;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
        }

        /* ã‚°ãƒ©ãƒ•ã‚’2åˆ—ï¼ˆPCï¼‰ã¾ãŸã¯1åˆ—ï¼ˆã‚¹ãƒãƒ›ï¼‰ã«ä¸¦ã¹ã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .chart-wrapper {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã§Canvasã‚’è¦ªã„ã£ã±ã„ã«åºƒã’ã‚‹ */
            display: flex;
            flex-direction: column;
            height: 350px;
        }

        .chart-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1rem;
        }

        .canvas-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            height: 100%; /* é«˜ã•ç¢ºä¿ã®ãŸã‚ã«è¿½åŠ  */
            /* min-heightã‚’æŒ‡å®šã—ã¦ã¤ã¶ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            min-height: 0; 
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }
    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>å²©å›½å¸‚ã®å¤©æ°—äºˆå ±</h1>
            <p class="subtitle">ä»Šå¾Œ24æ™‚é–“ã®ã‚°ãƒ©ãƒ•è¡¨ç¤º (Powered by Open-Meteo)</p>
            <div id="current-time" class="timestamp"></div>
        </header>
        
        <main id="main-content">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </main>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const container = document.getElementById('main-content');
            if (container) {
                container.innerHTML = `
                    <div style="color: #d32f2f; background: #ffebee; padding: 20px; border-radius: 8px;">
                        <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</strong><br>${message}
                    </div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const LAT = 34.16;
            const LON = 132.22;
            const apiURL = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,precipitation_probability,precipitation&timezone=Asia%2FTokyo`;

            const mainContent = document.getElementById('main-content');
            const timeDisplay = document.getElementById('current-time');

            // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
            const now = new Date();
            if (timeDisplay) {
                timeDisplay.textContent = `å–å¾—æ—¥æ™‚: ${now.toLocaleString('ja-JP')}`;
            }

            console.log("Fetching URL:", apiURL);

            fetch(apiURL)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    renderGraphs(data);
                })
                .catch(error => {
                    console.error("Render Error:", error);
                    mainContent.innerHTML = `
                        <div class="loading" style="color: #d32f2f;">
                            ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>${error.message}</small>
                        </div>`;
                });

            function renderGraphs(data) {
                mainContent.innerHTML = `
                    <div class="charts-container">
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸŒ¡ï¸ æ°—æ¸© (â„ƒ)</div>
                            <div class="canvas-container">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">â˜” é™æ°´ç¢ºç‡ (%)</div>
                            <div class="canvas-container">
                                <canvas id="rainChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸ’§ é™æ°´é‡ (mm)</div>
                            <div class="canvas-container">
                                <canvas id="precipChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                const hourly = data.hourly;
                
                // ç¾åœ¨æ™‚åˆ» (JST) ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
                const nowJST = new Date(Date.now() + 9 * 60 * 60 * 1000);
                const currentIsoJST = nowJST.toISOString().slice(0, 16);
                
                let startIndex = 0;
                if (hourly && hourly.time) {
                    startIndex = hourly.time.findIndex(t => t >= currentIsoJST);
                    if (startIndex === -1) startIndex = 0;
                }

                // 24æ™‚é–“åˆ†ã«åˆ¶é™
                const count = 24;
                const totalLength = hourly && hourly.time ? hourly.time.length : 0;
                const endIndex = Math.min(startIndex + count, totalLength);

                // ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’ä½œæˆ
                const labels = [];
                const temps = [];
                const probs = [];
                const precips = [];

                if (totalLength > 0) {
                    for (let i = startIndex; i < endIndex; i++) {
                        const timeStr = hourly.time[i];
                        const dateObj = new Date(timeStr);
                        const hour = dateObj.getHours();
                        const day = dateObj.getDate();
                        
                        let label = `${hour}:00`;
                        if (hour === 0 || i === startIndex) {
                            label = `${day}æ—¥ ${hour}:00`;
                        }
                        labels.push(label);

                        // æ°—æ¸©
                        temps.push(hourly.temperature_2m ? hourly.temperature_2m[i] : null);

                        // é™æ°´ç¢ºç‡
                        let prob = hourly.precipitation_probability ? (hourly.precipitation_probability[i] || 0) : 0;
                        // 0ã®å ´åˆã§ã‚‚ã‚°ãƒ©ãƒ•ã«è¦‹ãˆã‚‹ã‚ˆã†ã«å¾®å°å€¤ã‚’å…¥ã‚Œã‚‹
                        if (prob === 0) prob = 0.5;
                        probs.push(prob);

                        // é™æ°´é‡
                        let precip = hourly.precipitation ? (hourly.precipitation[i] || 0) : 0;
                        // 0ã®å ´åˆã§ã‚‚ã‚°ãƒ©ãƒ•ã«è¦‹ãˆã‚‹ã‚ˆã†ã«å¾®å°å€¤ã‚’å…¥ã‚Œã‚‹
                        if (precip === 0) precip = 0.1;
                        precips.push(precip);
                    }
                }

                console.log("Processed Data:", { labels, temps, probs, precips });

                // --- å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³ ---
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                };
                
                // ã‚¼ãƒ­ãƒ©ã‚¤ãƒ³å¼·èª¿ç”¨ã®ã‚°ãƒªãƒƒãƒ‰è¨­å®š
                const zeroLineGrid = {
                    color: (context) => context.tick.value === 0 ? '#888' : '#ddd',
                    lineWidth: (context) => context.tick.value === 0 ? 2 : 1,
                };

                // --- æ°—æ¸©ã‚°ãƒ©ãƒ•æç”» ---
                try {
                    const tempCanvas = document.getElementById('tempChart');
                    if (tempCanvas && temps.length > 0) {
                        new Chart(tempCanvas, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'æ°—æ¸©',
                                    data: temps,
                                    borderColor: '#ffb703',
                                    backgroundColor: 'rgba(255, 183, 3, 0.2)',
                                    borderWidth: 2,
                                    tension: 0.3, 
                                    fill: true,
                                    pointRadius: 3
                                }]
                            },
                            options: {
                                ...commonOptions,
                                scales: {
                                    y: { 
                                        beginAtZero: false, 
                                        title: { display: true, text: 'â„ƒ' },
                                        suggestedMin: Math.min(...temps) - 2, 
                                        suggestedMax: Math.max(...temps) + 2
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error(e); }

                // --- é™æ°´ç¢ºç‡ã‚°ãƒ©ãƒ•æç”» ---
                try {
                    const rainCanvas = document.getElementById('rainChart');
                    if (rainCanvas && probs.length > 0) {
                        new Chart(rainCanvas, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'é™æ°´ç¢ºç‡',
                                    data: probs,
                                    backgroundColor: '#0077b6',
                                    borderColor: '#005f87',
                                    borderWidth: 1,
                                    borderRadius: 4,
                                    barPercentage: 0.8,
                                    minBarLength: 5, // æœ€å°ã®é«˜ã•ã‚’ç¢ºä¿
                                }]
                            },
                            options: {
                                ...commonOptions,
                                scales: {
                                    y: { 
                                        min: -5,
                                        max: 100,
                                        title: { display: true, text: '%' },
                                        grid: zeroLineGrid,
                                        ticks: { 
                                            stepSize: 20,
                                            // ãƒã‚¤ãƒŠã‚¹ã®å€¤ã¯è¡¨ç¤ºã—ãªã„
                                            callback: function(value) {
                                                return value < 0 ? '' : value;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error(e); }

                // --- é™æ°´é‡ã‚°ãƒ©ãƒ•æç”» (æ–°è¦) ---
                try {
                    const precipCanvas = document.getElementById('precipChart');
                    if (precipCanvas && precips.length > 0) {
                        new Chart(precipCanvas, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'é™æ°´é‡',
                                    data: precips,
                                    backgroundColor: '#4cc9f0',
                                    borderColor: '#4361ee',
                                    borderWidth: 1,
                                    borderRadius: 4,
                                    barPercentage: 0.8,
                                    minBarLength: 5, // æœ€å°ã®é«˜ã•ã‚’ç¢ºä¿
                                }]
                            },
                            options: {
                                ...commonOptions,
                                scales: {
                                    y: { 
                                        min: -0.5, 
                                        title: { display: true, text: 'mm' },
                                        suggestedMax: 5,
                                        grid: zeroLineGrid,
                                        ticks: {
                                            // ãƒã‚¤ãƒŠã‚¹ã®å€¤ã¯è¡¨ç¤ºã—ãªã„
                                            callback: function(value) {
                                                return value < 0 ? '' : value;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) { console.error(e); }
            }
        });
    </script>
</body>
</html>