<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²©å›½å¸‚ å¤©æ°—äºˆå ±ã‚°ãƒ©ãƒ• (24æ™‚é–“)</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0077b6;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
        }

        /* ã‚°ãƒ©ãƒ•ã‚’2åˆ—ï¼ˆPCï¼‰ã¾ãŸã¯1åˆ—ï¼ˆã‚¹ãƒãƒ›ï¼‰ã«ä¸¦ã¹ã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .chart-wrapper {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹ã§Canvasã‚’è¦ªã„ã£ã±ã„ã«åºƒã’ã‚‹ */
            display: flex;
            flex-direction: column;
            height: 350px;
        }

        .chart-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1rem;
        }

        .canvas-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            /* min-heightã‚’æŒ‡å®šã—ã¦ã¤ã¶ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            min-height: 0; 
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }
    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>å²©å›½å¸‚ã®å¤©æ°—äºˆå ±</h1>
            <p class="subtitle">ä»Šå¾Œ24æ™‚é–“ã®ã‚°ãƒ©ãƒ•è¡¨ç¤º (Powered by Open-Meteo)</p>
            <div id="current-time" class="timestamp"></div>
        </header>
        
        <main id="main-content">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </main>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const container = document.getElementById('main-content');
            if (container) {
                container.innerHTML = `
                    <div style="color: #d32f2f; background: #ffebee; padding: 20px; border-radius: 8px;">
                        <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</strong><br>${message}
                    </div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const LAT = 34.16;
            const LON = 132.22;
            const apiURL = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,precipitation_probability&timezone=Asia%2FTokyo`;

            const mainContent = document.getElementById('main-content');
            const timeDisplay = document.getElementById('current-time');

            // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
            const now = new Date();
            if (timeDisplay) {
                timeDisplay.textContent = `å–å¾—æ—¥æ™‚: ${now.toLocaleString('ja-JP')}`;
            }

            console.log("Fetching URL:", apiURL);

            fetch(apiURL)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTPã‚¨ãƒ©ãƒ¼ status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    renderGraphs(data);
                })
                .catch(error => {
                    console.error("Render Error:", error);
                    mainContent.innerHTML = `
                        <div class="loading" style="color: #d32f2f;">
                            ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>${error.message}</small>
                        </div>`;
                });

            function renderGraphs(data) {
                mainContent.innerHTML = `
                    <div class="charts-container">
                        <div class="chart-wrapper">
                            <div class="chart-title">ğŸŒ¡ï¸ æ°—æ¸© (â„ƒ)</div>
                            <div class="canvas-container">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-title">â˜” é™æ°´ç¢ºç‡ (%)</div>
                            <div class="canvas-container">
                                <canvas id="rainChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                const hourly = data.hourly;
                if (!hourly || !hourly.precipitation_probability) {
                    throw new Error("é™æ°´ç¢ºç‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                }
                
                // ç¾åœ¨æ™‚åˆ» (JST) ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
                const nowJST = new Date(Date.now() + 9 * 60 * 60 * 1000);
                const currentIsoJST = nowJST.toISOString().slice(0, 16);
                
                let startIndex = hourly.time.findIndex(t => t >= currentIsoJST);
                if (startIndex === -1) startIndex = 0;

                // 24æ™‚é–“åˆ†ã«åˆ¶é™
                const count = 24;
                const endIndex = Math.min(startIndex + count, hourly.time.length);

                // ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’ä½œæˆ
                const labels = [];
                const temps = [];
                const probs = [];

                for (let i = startIndex; i < endIndex; i++) {
                    const timeStr = hourly.time[i];
                    const dateObj = new Date(timeStr);
                    const hour = dateObj.getHours();
                    const day = dateObj.getDate();
                    
                    let label = `${hour}:00`;
                    if (hour === 0 || i === startIndex) {
                        label = `${day}æ—¥ ${hour}:00`;
                    }
                    labels.push(label);

                    temps.push(hourly.temperature_2m[i]);
                    // nullã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†
                    probs.push(hourly.precipitation_probability[i] || 0);
                }

                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                console.log("Processed Data:", { labels, temps, probs });

                // æ°—æ¸©ã‚°ãƒ©ãƒ•æç”»
                new Chart(document.getElementById('tempChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ°—æ¸©',
                            data: temps,
                            borderColor: '#ffb703',
                            backgroundColor: 'rgba(255, 183, 3, 0.2)',
                            borderWidth: 2,
                            tension: 0.3, 
                            fill: true,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: false, title: { display: true, text: 'â„ƒ' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // é™æ°´ç¢ºç‡ã‚°ãƒ©ãƒ•æç”»
                const rainCtx = document.getElementById('rainChart');
                new Chart(rainCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'é™æ°´ç¢ºç‡',
                            data: probs,
                            backgroundColor: '#0077b6',
                            borderColor: '#005f87',
                            borderWidth: 1,
                            borderRadius: 4,
                            // æ£’ã®å¹…ã‚’èª¿æ•´
                            barPercentage: 0.8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                min: 0,
                                max: 100, // å¸¸ã«0-100%ã§è¡¨ç¤º
                                title: { display: true, text: '%' },
                                ticks: { stepSize: 20 }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        });
    </script>
</body>
</html>